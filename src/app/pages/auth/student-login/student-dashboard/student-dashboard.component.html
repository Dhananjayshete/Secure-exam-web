<div class="dashboard-container">

    <!-- 1. LEFT SIDEBAR MENU -->
    <aside class="sidebar">
        <div class="brand">
            <i class="fa-solid fa-graduation-cap"></i> Secure<span>Take</span>
        </div>

        <div class="nav-title">Menu</div>

        <a class="nav-item" [class.active]="currentView === 'dashboard'" (click)="switchView('dashboard')">
            <i class="fa-solid fa-house"></i> Dashboard
        </a>
        <a class="nav-item" [class.active]="currentView === 'upcoming'" (click)="switchView('upcoming')">
            <i class="fa-solid fa-calendar-check"></i> Upcoming Exams
        </a>
        <a class="nav-item" [class.active]="currentView === 'history'" (click)="switchView('history')">
            <i class="fa-solid fa-clock-rotate-left"></i> Exam History
        </a>
        <a class="nav-item" [class.active]="currentView === 'results'" (click)="switchView('results')">
            <i class="fa-solid fa-trophy"></i> Results
        </a>
        <a class="nav-item" [class.active]="currentView === 'admit'" (click)="switchView('admit')">
            <i class="fa-solid fa-id-card"></i> Admit Card
        </a>

        <div class="nav-title">Settings</div>

        <a class="nav-item" [class.active]="currentView === 'profile'" (click)="switchView('profile')">
            <i class="fa-solid fa-user"></i> Profile
        </a>
        <a class="nav-item" [class.active]="currentView === 'password'" (click)="switchView('password')">
            <i class="fa-solid fa-key"></i> Change Password
        </a>
        <a class="nav-item" [class.active]="currentView === 'support'" (click)="switchView('support')">
            <i class="fa-solid fa-headset"></i> Support
        </a>

        <div class="motivation-card">
            <h4>Focus Mode üéØ</h4>
            <p>You have an exam in 2 days.</p>
        </div>
    </aside>

    <!-- 2. MAIN CONTENT AREA -->
    <div class="main-wrapper">

        <!-- Header -->
        <header class="top-bar">
            <div class="date-badge"><i class="fa-regular fa-calendar"></i> Academic Portal</div>

            <div class="actions-right">
                <i class="fa-regular fa-bell notification-icon"></i>
                <div class="user-pill" (click)="switchView('profile')">
                    <div class="user-info">
                        <div class="name">{{ studentProfile.name }}</div>
                        <div class="role">Student</div>
                    </div>
                    <div class="avatar"><img [src]="studentProfile.avatar" alt="User"></div>
                </div>
                <i class="fa-solid fa-right-from-bracket logout-btn" (click)="logout()"></i>
            </div>
        </header>

        <div class="content">

            <!-- A. DASHBOARD OVERVIEW -->
            <div *ngIf="currentView === 'dashboard'" class="view-section fade-in">
                <div class="hero-banner">
                    <div class="hero-text">
                        <h1>Hello, {{ studentProfile.name }}!</h1>
                        <p>Track your progress and upcoming schedules.</p>
                    </div>
                    <img src="https://cdn-icons-png.flaticon.com/512/7466/7466140.png" class="hero-img">
                </div>

                <!-- Cards Section -->
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="icon-circle orange"><i class="fa-solid fa-list"></i></div>
                        <div>
                            <h3>{{ stats.total }}</h3><span>Total Exams</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon-circle blue"><i class="fa-solid fa-calendar-day"></i></div>
                        <div>
                            <h3>{{ stats.upcoming }}</h3><span>Upcoming</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon-circle green"><i class="fa-solid fa-check-circle"></i></div>
                        <div>
                            <h3>{{ stats.completed }}</h3><span>Completed</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon-circle purple"><i class="fa-solid fa-chart-line"></i></div>
                        <div>
                            <h3>{{ stats.latestScore }}</h3><span>Latest Result</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- B. UPCOMING EXAMS PAGE -->
            <div *ngIf="currentView === 'upcoming'" class="view-section fade-in">
                <h2 class="page-title">Upcoming Exams</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Exam Name</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let exam of upcomingExams">
                                <td>
                                    <div style="font-weight:bold;">{{ exam.name }}</div>
                                    <div style="font-size:12px; color:#64748b;" *ngIf="exam.countdown">{{ exam.countdown
                                        }}</div>
                                </td>
                                <td>
                                    <div>Start: {{ exam.displayDate }}</div>
                                    <div style="font-size:11px; color:#94a3b8;">End: {{ exam.displayEndDate || 'No
                                        limit' }}</div>
                                </td>
                                <td>{{ exam.time }}</td>
                                <td>{{ exam.duration }}</td>
                                <td>
                                    <span class="status-badge"
                                        [ngClass]="{'ready': exam.isStartable, 'locked': !exam.isStartable}">
                                        {{ exam.displayStatus }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm"
                                        [ngClass]="exam.displayStatus === 'Expired' ? 'btn-disabled' : 'btn-primary'"
                                        [disabled]="exam.displayStatus === 'Expired'" (click)="startExam(exam)">
                                        {{ exam.displayStatus === 'Scheduled' ? 'View Details' : 'Start Exam' }}
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- C. EXAM HISTORY PAGE -->
            <div *ngIf="currentView === 'history'" class="view-section fade-in">
                <app-exam-history></app-exam-history>
            </div>

            <!-- D. RESULTS PAGE -->
            <div *ngIf="currentView === 'results'" class="view-section fade-in">
                <h2 class="page-title">Results & Scorecards</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Exam</th>
                                <th>Score</th>
                                <th>Result</th>
                                <th>Download</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let res of results">
                                <td><strong>{{ res.exam }}</strong></td>
                                <td>{{ res.score }}</td>
                                <td><span class="status-pass">{{ res.grade }}</span></td>
                                <td><button class="btn btn-sm btn-primary">Download PDF</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- E. ADMIT CARD SECTION -->
            <div *ngIf="currentView === 'admit'" class="view-section fade-in">
                <div class="admit-card-modern">
                    <div class="admit-top">
                        <h2>SecureTake University</h2>
                        <p>ADMIT CARD 2024</p>
                    </div>
                    <div class="admit-body">
                        <div class="info-group"><label>Name</label>
                            <div>{{ studentProfile.name }}</div>
                        </div>
                        <div class="info-group"><label>Roll No</label>
                            <div>{{ studentProfile.rollNo }}</div>
                        </div>
                        <div class="info-group"><label>Center</label>
                            <div>Online (Home)</div>
                        </div>
                        <div class="info-group"><label>Timing</label>
                            <div>10:00 AM</div>
                        </div>
                    </div>
                    <button class="btn btn-primary full-width" onclick="window.print()">Download Admit Card</button>
                </div>
            </div>

            <div *ngIf="currentView === 'profile'" class="view-section fade-in">
                <h2 class="page-title">My Profile</h2>
                <div class="table-container compact-form"
                    style="max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                    <div class="profile-header" style="text-align: center; margin-bottom: 25px;">
                        <img [src]="studentProfile.avatar" class="profile-pic-lg"
                            style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #eef2ff;">
                        <div
                            style="margin-top: 10px; color: #4f46e5; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
                            Change Photo</div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Full Name</label>
                            <input type="text" [(ngModel)]="studentProfile.name"
                                style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Roll Number</label>
                            <input type="text" [value]="studentProfile.rollNo" disabled
                                style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; color: #64748b;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Email Address</label>
                            <input type="text" [value]="studentProfile.email" disabled
                                style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; color: #64748b;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Phone Number</label>
                            <input type="text" [(ngModel)]="studentProfile.phone"
                                style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Batch</label>
                            <input type="text" [(ngModel)]="studentProfile.batch" placeholder="e.g. 2024"
                                style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Department</label>
                            <input type="text" [(ngModel)]="studentProfile.dept" placeholder="e.g. Computer Science"
                                style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                        </div>
                    </div>

                    <button class="btn btn-primary full-width" (click)="updateProfile()"
                        style="padding: 12px; font-weight: 600;">Update Profile</button>
                </div>
            </div>

            <div *ngIf="currentView === 'password'" class="view-section fade-in">
                <h2 class="page-title">Change Password</h2>
                <div class="table-container compact-form"
                    style="max-width: 450px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                    <div style="text-align: center; margin-bottom: 20px; color: #64748b;">
                        <i class="fa-solid fa-shield-halved"
                            style="font-size: 2.5rem; color: #4f46e5; margin-bottom: 15px;"></i>
                        <p>Keep your account secure with a strong password.</p>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Old Password</label>
                        <input type="password" [(ngModel)]="passwordForm.old"
                            style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">New Password</label>
                        <input type="password" [(ngModel)]="passwordForm.new"
                            style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                    </div>

                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Confirm New
                            Password</label>
                        <input type="password" [(ngModel)]="passwordForm.confirm"
                            style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                    </div>

                    <button class="btn btn-primary full-width" (click)="updatePassword()"
                        style="padding: 12px; font-weight: 600;">Update Password</button>
                </div>
            </div>

            <!-- I. COMPLETION VIEW -->
            <div *ngIf="currentView === 'completion'" class="view-section fade-in">
                <div class="panel"
                    style="text-align:center; padding:50px; border-radius:15px; background:white; box-shadow:0 10px 25px rgba(0,0,0,0.05);">
                    <div class="icon-circle green" style="width:80px; height:80px; font-size:2rem; margin:0 auto 20px;">
                        <i class="fa-solid fa-check"></i>
                    </div>
                    <h1 style="color:var(--text-main); margin-bottom:10px;">Exam Completed!</h1>
                    <p style="color:#64748b; font-size:1.1rem; margin-bottom:30px;">Well done, you have successfully
                        submitted your exam.</p>

                    <div
                        style="display:grid; grid-template-columns: repeat(2, 1fr); gap:20px; max-width:500px; margin:0 auto 30px; text-align:left;">
                        <div class="stat-card" style="padding:15px; background:#f8fafc;">
                            <label style="display:block; font-size:12px; color:#94a3b8; text-transform:uppercase;">Exam
                                Title</label>
                            <strong>{{ completionData?.title }}</strong>
                        </div>
                        <div class="stat-card" style="padding:15px; background:#f8fafc;">
                            <label
                                style="display:block; font-size:12px; color:#94a3b8; text-transform:uppercase;">Score</label>
                            <strong>{{ completionData?.percentage }}% ({{ completionData?.grade }})</strong>
                        </div>
                        <div class="stat-card" style="padding:15px; background:#f8fafc;">
                            <label
                                style="display:block; font-size:12px; color:#94a3b8; text-transform:uppercase;">Attempted</label>
                            <strong>{{ completionData?.questionsAttempted }} / {{ completionData?.totalQuestions
                                }}</strong>
                        </div>
                        <div class="stat-card" style="padding:15px; background:#f8fafc;">
                            <label
                                style="display:block; font-size:12px; color:#94a3b8; text-transform:uppercase;">Date</label>
                            <strong>{{ completionData?.date }}</strong>
                        </div>
                    </div>

                    <div style="display:flex; gap:15px; justify-content:center;">
                        <button class="btn btn-primary" (click)="switchView('results')">Go to Results</button>
                        <button class="btn btn-outline" (click)="switchView('history')">View Exam History</button>
                    </div>
                </div>
            </div>

            <!-- J. SUPPORT SECTION -->

        </div>
    </div>
</div>

<!-- ==========================
     VERIFICATION MODAL
     ========================== -->
<div class="modal-overlay" *ngIf="isVerificationModalOpen">
    <div class="verification-modal">
        <div class="modal-header">
            <h3>Start Exam: {{ targetExam?.name }}</h3>
            <button class="close-btn" (click)="closeVerificationModal()">&times;</button>
        </div>

        <!-- STEP 1: PASSWORD -->
        <div class="modal-body" *ngIf="verificationStep === 'password'">
            <div class="verify-icon"><i class="fa-solid fa-lock"></i></div>
            <h4>Identity Verification</h4>
            <p>Please re-enter your password to confirm it's you.</p>

            <div class="form-group">
                <input type="password" [(ngModel)]="verificationPassword" placeholder="Enter your password"
                    class="form-control" (keyup.enter)="verifyPassword()">
                <div class="error-msg" *ngIf="verificationError">{{ verificationError }}</div>
            </div>

            <button class="btn btn-primary full-width" (click)="verifyPassword()">Verify Identity</button>
        </div>

        <!-- STEP 2: SYSTEM CHECK -->
        <div class="modal-body" *ngIf="verificationStep === 'system-check'">
            <div class="verify-icon"><i class="fa-solid fa-laptop-code"></i></div>
            <h4>System Check</h4>
            <p>We need to access your camera and microphone for proctoring.</p>

            <div class="check-list">
                <div class="check-item">
                    <span><i class="fa-solid fa-camera"></i> Camera</span>
                    <span [class.success]="systemCheckStatus.camera" [class.fail]="!systemCheckStatus.camera">
                        <i class="fa-solid" [class.fa-check]="systemCheckStatus.camera"
                            [class.fa-xmark]="!systemCheckStatus.camera"></i>
                    </span>
                </div>
                <div class="check-item">
                    <span><i class="fa-solid fa-microphone"></i> Microphone</span>
                    <span [class.success]="systemCheckStatus.mic" [class.fail]="!systemCheckStatus.mic">
                        <i class="fa-solid" [class.fa-check]="systemCheckStatus.mic"
                            [class.fa-xmark]="!systemCheckStatus.mic"></i>
                    </span>
                </div>
            </div>

            <div class="error-msg" *ngIf="systemCheckStatus.error" style="margin-top: 10px;">{{ systemCheckStatus.error
                }}</div>

            <div class="modal-actions">
                <button class="btn btn-outline" (click)="checkSystemPermissions()">Retry</button>
                <button class="btn btn-primary" [disabled]="!systemCheckStatus.camera || !systemCheckStatus.mic"
                    (click)="confirmStartExam()">Start Exam</button>
            </div>
        </div>
    </div>
</div>

<!-- ==========================
     SCHEDULED EXAM MODAL
     ========================== -->
<div class="modal-overlay" *ngIf="isScheduledModalOpen">
    <div class="verification-modal" style="max-width:400px;">
        <div class="modal-header">
            <h3>Exam Scheduled</h3>
            <button class="close-btn" (click)="closeScheduledModal()">&times;</button>
        </div>
        <div class="modal-body" style="text-align:center; padding:30px;">
            <div class="verify-icon" style="background:#eff6ff; color:#3b82f6;"><i
                    class="fa-solid fa-calendar-clock"></i></div>
            <h4 style="margin-top:20px;">{{ scheduledExam?.name }}</h4>
            <p style="color:#64748b; margin-top:10px;">This exam is not yet active. Please wait for the scheduled start
                time.</p>

            <div style="background:#f8fafc; padding:15px; border-radius:10px; margin:20px 0;">
                <label style="display:block; font-size:12px; color:#94a3b8; text-transform:uppercase;">Starts At</label>
                <strong style="font-size:1.1rem; color:var(--text-main);">{{ scheduledExam?.displayDate }}</strong>
                <div style="color:#3b82f6; font-weight:600; margin-top:5px; font-family:monospace;">
                    {{ scheduledExam?.countdown }}
                </div>
            </div>

            <button class="btn btn-primary full-width" (click)="closeScheduledModal()">Got it!</button>
        </div>
    </div>
</div>

<!-- ==========================
     3. EXAM INTERFACE (SECURITY MODE)
     ========================== -->
<div id="exam-interface" *ngIf="isExamActive" [class.active]="isExamActive">
    <div class="exam-navbar">
        <div style="font-weight:700;">{{ activeExamTitle }}</div>
        <div class="timer-pill">{{ timerDisplay }}</div>
        <button class="btn btn-sm btn-danger" (click)="submitExam()">Submit Exam</button>
    </div>
    <div class="exam-layout">
        <!-- Question Panel -->
        <div class="question-panel">
            <div class="q-card" *ngIf="currentQuestion">
                <div class="q-meta">QUESTION {{ currentQuestionIndex + 1 }} OF {{ examQuestions.length }} ¬∑ {{
                    currentQuestion.points }} pts</div>
                <div class="q-text">{{ currentQuestion.questionText }}</div>

                <!-- MCQ Options -->
                <ng-container *ngIf="currentQuestion.questionType === 'MCQ'">
                    <label class="option-box" *ngFor="let opt of currentQuestion.options"
                        [class.selected]="getSelectedOptionId(currentQuestion.id) === opt.id"
                        (click)="selectOption(currentQuestion.id, opt.id)">
                        <input type="radio" [name]="'q_' + currentQuestion.id" [value]="opt.id"
                            [checked]="getSelectedOptionId(currentQuestion.id) === opt.id">
                        {{ opt.optionText }}
                    </label>
                </ng-container>

                <!-- Short Answer / Essay -->
                <ng-container
                    *ngIf="currentQuestion.questionType === 'short_answer' || currentQuestion.questionType === 'essay'">
                    <textarea [rows]="currentQuestion.questionType === 'essay' ? 8 : 3"
                        [value]="getTextAnswer(currentQuestion.id)"
                        (input)="setTextAnswer(currentQuestion.id, $any($event.target).value)"
                        [placeholder]="currentQuestion.questionType === 'essay' ? 'Write your essay here...' : 'Type your answer...'"
                        style="width:100%; padding:12px; border:1px solid #e2e8f0; border-radius:8px; margin-top:12px; resize:vertical; font-family:inherit;"></textarea>
                </ng-container>

                <div class="q-actions">
                    <button class="btn btn-sm btn-outline" (click)="prevQuestion()"
                        [disabled]="currentQuestionIndex === 0">Previous</button>
                    <button class="btn btn-sm btn-primary" (click)="nextQuestion()"
                        *ngIf="currentQuestionIndex < examQuestions.length - 1">Next</button>
                    <button class="btn btn-sm btn-danger" (click)="submitExam()"
                        *ngIf="currentQuestionIndex === examQuestions.length - 1">Submit Exam</button>
                </div>
            </div>
            <div *ngIf="!currentQuestion" style="text-align:center; padding:40px; color:#94a3b8;">
                No questions loaded for this exam.
            </div>
        </div>
        <!-- Sidebar (Question Palette) -->
        <div class="sidebar-right">
            <div class="cam-preview"><span class="rec">‚óè REC</span></div>
            <div class="q-palette">
                <div *ngFor="let q of examQuestions; let i = index" class="q-dot"
                    [class.current]="i === currentQuestionIndex" [class.solved]="isAnswered(q.id)"
                    (click)="goToQuestion(i)">
                    {{ i + 1 }}
                </div>
            </div>
        </div>
    </div>
</div>