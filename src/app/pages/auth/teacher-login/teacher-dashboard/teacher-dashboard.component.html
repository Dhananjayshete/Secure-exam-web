<!-- MAIN CONTAINER -->
<div class="dashboard-container">

  <!-- ==================== SIDEBAR (LEFT) ==================== -->
  <aside class="sidebar">
    <div class="brand">
      <i class="fa-solid fa-shield-cat"></i> Secure<span>Take</span>
    </div>

    <!-- Navigation Group 1 -->
    <div class="nav-group">
      <div class="nav-label">Overview</div>

      <!-- Dashboard Button -->
      <a class="nav-item" [class.active]="currentView === 'dashboard'" (click)="switchView('dashboard')">
        <i class="fa-solid fa-grid-2"></i> Dashboard
      </a>

      <!-- Exams Button -->
      <a class="nav-item" [class.active]="currentView === 'exams'" (click)="switchView('exams')">
        <i class="fa-solid fa-file-contract"></i> Exam Manager
      </a>

      <!-- Analytics Button -->
      <a class="nav-item" [class.active]="currentView === 'analytics'" (click)="switchView('analytics')">
        <i class="fa-solid fa-chart-pie"></i> Analytics
      </a>
    </div>

    <!-- Navigation Group 2 -->
    <div class="nav-group">
      <div class="nav-label">Proctoring</div>
      <a class="nav-item" [class.active]="currentView === 'monitor'" (click)="switchView('monitor')">
        <i class="fa-solid fa-eye"></i> Live Monitor
        <span class="live-dot"></span>
      </a>
    </div>

    <!-- Navigation Group 3 -->
    <div class="nav-group">
      <div class="nav-label">Academics</div>
      <a class="nav-item" [class.active]="currentView === 'grading'" (click)="switchView('grading')">
        <i class="fa-solid fa-pen-to-square"></i> Grading Hub
      </a>
      <a class="nav-item" [class.active]="currentView === 'students'" (click)="switchView('students')">
        <i class="fa-solid fa-users"></i> Students
      </a>
    </div>

    <!-- User Profile at Bottom -->
    <div class="sidebar-footer">
      <div class="user-card" (click)="logout()">
        <img src="https://images.unsplash.com/photo-1568602471122-7832951cc4c5?w=100" class="user-avatar" alt="User">
        <div>
          <h4>Prof. saniya yadav</h4>
          <p>Administrator</p>
        </div>
        <i class="fa-solid fa-right-from-bracket logout-icon"></i>
      </div>
    </div>
  </aside>

  <!-- ==================== MAIN CONTENT (RIGHT) ==================== -->
  <div class="main-content">

    <!-- TOP BAR (Header) -->
    <header class="top-bar">
      <div class="breadcrumbs">
        Home / <strong>{{ currentView | titlecase }}</strong>
      </div>
      <div class="actions">
        <!-- GLOBAL SEARCH BAR -->
        <div class="search-box">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input type="text" placeholder="Search students, IDs, exams..." [(ngModel)]="searchTerm">
        </div>
        <button class="icon-btn"><i class="fa-regular fa-bell"></i>
          <div class="badge">3</div>
        </button>
      </div>
    </header>

    <!-- ANALYTICS SECTION -->
    <div *ngIf="currentView === 'analytics'" class="view-section fade-in">
      <h2 class="page-title">Summary Analytics</h2>

      <div *ngIf="isAnalyticsLoading" class="loading-state">
        <i class="fa-solid fa-circle-notch fa-spin"></i> Loading stats...
      </div>

      <div *ngIf="!isAnalyticsLoading && analytics" class="analytics-grid">
        <div class="stat-card">
          <label>Total Exams</label>
          <div class="value">{{ analytics.summary.total_exams }}</div>
        </div>
        <div class="stat-card">
          <label>Upcoming</label>
          <div class="value" style="color:#3b82f6;">{{ analytics.summary.upcoming_exams }}</div>
        </div>
        <div class="stat-card">
          <label>Completed</label>
          <div class="value" style="color:#10b981;">{{ analytics.summary.completed_exams }}</div>
        </div>
      </div>

      <div *ngIf="!isAnalyticsLoading && analytics" style="margin-top:30px;">
        <h3>Average Scores per Exam</h3>
        <div class="chart-container" style="background:white; padding:20px; border-radius:12px; margin-top:20px;">
          <div *ngFor="let item of analytics.avgScores" style="margin-bottom:15px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
              <span>{{ item.title }}</span>
              <strong>{{ item.average_score }}%</strong>
            </div>
            <div style="height:10px; background:#f1f5f9; border-radius:10px; overflow:hidden;">
              <div [style.width.%]="item.average_score" style="height:100%; background:#4f46e5;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- GRADING HUB -->
    <div *ngIf="currentView === 'grading'" class="view-section fade-in">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 class="page-title">Grading Hub</h2>
        <button class="btn-outline" (click)="loadGrading()"><i class="fa-solid fa-arrows-rotate"></i> Refresh</button>
      </div>

      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Exam Name</th>
              <th>Subject</th>
              <th>Date</th>
              <th>Candidates</th>
              <th>Avg. Score</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let ex of gradingList">
              <td><strong>{{ ex.title }}</strong></td>
              <td>{{ ex.subject }}</td>
              <td>{{ ex.date }}</td>
              <td>{{ ex.candidates_count }}</td>
              <td>
                <span class="badge" [ngClass]="ex.avg_score >= 60 ? 'badge-green' : 'badge-orange'">
                  {{ ex.avg_score || 0 }}%
                </span>
              </td>
              <td>
                <button class="btn-sm btn-outline">View Attempts</button>
              </td>
            </tr>
            <tr *ngIf="gradingList.length === 0 && !isGradingLoading">
              <td colspan="6" style="text-align:center; padding:30px; color:#64748b;">No exams found for grading.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ==================== VIEW 1: DASHBOARD ==================== -->
    <div *ngIf="currentView === 'dashboard'" class="view-section fade-in">
      <div class="page-header">
        <div>
          <h1>Dashboard Overview</h1>
          <p>Welcome back. You have <strong>2 exams</strong> running live today.</p>
        </div>
        <button class="btn-primary" (click)="openModal()"><i class="fa-solid fa-plus"></i> Quick Exam</button>
      </div>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="icon-box orange"><i class="fa-solid fa-calendar-check"></i></div>
          <div>
            <h2>12</h2>
            <p>Total Exams</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="icon-box green"><i class="fa-solid fa-user-graduate"></i></div>
          <div>
            <h2>450</h2>
            <p>Students</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="icon-box blue"><i class="fa-solid fa-video"></i></div>
          <div>
            <h2>02</h2>
            <p>Live Now</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="icon-box red"><i class="fa-solid fa-triangle-exclamation"></i></div>
          <div>
            <h2>07</h2>
            <p>Alerts</p>
          </div>
        </div>
      </div>

      <!-- Recent Exams Table -->
      <div class="panel">
        <div class="panel-header">
          <h3>Recent Activity</h3>
        </div>
        <table>
          <thead>
            <tr>
              <th>Exam</th>
              <th>Date</th>
              <th>Candidates</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let exam of exams">
              <td><strong>{{ exam.title }}</strong></td>
              <td>{{ exam.date }}</td>
              <td>{{ exam.candidates }}</td>
              <td>
                <span class="status-badge"
                  [ngClass]="{'live': exam.status === 'Live', 'scheduled': exam.status === 'Scheduled', 'draft': exam.status === 'Draft'}">
                  {{ exam.status }}
                </span>
              </td>
              <td><button class="btn-icon" (click)="openMonitor(exam)"><i class="fa-solid fa-eye"></i></button></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ==================== VIEW 2: EXAM MANAGER ==================== -->
    <div *ngIf="currentView === 'exams'" class="view-section fade-in">
      <div class="page-header">
        <div>
          <h1>Exam Manager</h1>
          <p>Create and manage your assessments.</p>
        </div>
        <button class="btn-primary" (click)="openModal()"><i class="fa-solid fa-plus"></i> New Exam</button>
      </div>
      <div class="panel">
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Subject</th>
              <th>Security</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let exam of exams">
              <td>{{ exam.title }}</td>
              <td>{{ exam.subject }}</td>
              <td><i class="fa-solid fa-lock text-danger"></i> {{ exam.security }}</td>
              <td>{{ exam.status }}</td>
              <td>
                <div class="row-actions">
                  <button class="btn-icon" title="Manage Questions" (click)="openQuestions(exam)"><i
                      class="fa-solid fa-list-check"></i></button>
                  <button class="btn-icon" title="Monitor" (click)="openMonitor(exam)"><i
                      class="fa-solid fa-eye"></i></button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ==================== VIEW 3: LIVE MONITOR ==================== -->
    <div *ngIf="currentView === 'monitor'" class="view-section fade-in">
      <div class="page-header">
        <div>
          <h1>Live Proctoring</h1>
          <p>Monitoring: <strong>{{ selectedExamTitle || 'Select an exam' }}</strong></p>
        </div>
        <button class="btn-secondary" (click)="loadProctoringData()"><i class="fa-solid fa-arrows-rotate"></i>
          Refresh</button>
      </div>

      <div *ngIf="!monitorExamId" class="panel" style="padding:40px; text-align:center; color:#64748b;">
        <i class="fa-solid fa-eye" style="font-size:2rem; margin-bottom:12px;"></i>
        <p>Select an exam from the <strong>Exam Manager</strong> to start monitoring.</p>
      </div>

      <div *ngIf="monitorExamId" class="monitor-grid">
        <!-- Students Grid -->
        <div class="cam-grid">
          <div class="student-cam" *ngFor="let st of liveStudents" [class.alert]="st.status === 'flagged'">
            <img [src]="st.img" class="cam-feed">
            <div class="cam-overlay">
              <span>{{ st.name }}</span>
              <span *ngIf="st.status === 'good'" class="text-success"><i class="fa-solid fa-wifi"></i> Good</span>
              <span *ngIf="st.status === 'flagged'" class="text-danger"><i class="fa-solid fa-triangle-exclamation"></i>
                {{ st.flagCount }} flags</span>
            </div>
          </div>
          <div *ngIf="liveStudents.length === 0"
            style="grid-column:1/-1; text-align:center; padding:30px; color:#94a3b8;">
            No proctoring events recorded yet.
          </div>
        </div>

        <!-- Log Panel -->
        <div class="audit-log">
          <h4>Security Log</h4>
          <div *ngFor="let evt of proctoringEvents" class="log-item" [class.alert]="evt.eventType !== 'good'">
            <span>{{ evt.time }}</span>
            <i [class]="getEventIcon(evt.eventType)"></i>
            {{ evt.studentName }} — {{ evt.eventType | titlecase }}
            <span *ngIf="evt.details" style="color:#94a3b8;"> ({{ evt.details }})</span>
          </div>
          <div *ngIf="proctoringEvents.length === 0" style="text-align:center; padding:20px; color:#94a3b8;">No events
            yet.</div>
        </div>
      </div>
    </div>

    <!-- ==================== VIEW: MANAGE QUESTIONS ==================== -->
    <div *ngIf="currentView === 'questions'" class="view-section fade-in">
      <div class="page-header">
        <div>
          <h1>Manage Questions</h1>
          <p>Exam: <strong>{{ selectedExamTitle }}</strong> — {{ questions.length }} question(s)</p>
        </div>
        <button class="btn-secondary" (click)="switchView('exams')"><i class="fa-solid fa-arrow-left"></i> Back to
          Exams</button>
      </div>

      <!-- Existing Questions -->
      <div class="panel" style="margin-bottom: 20px;">
        <div class="panel-header">
          <h3>Questions</h3>
        </div>
        <div *ngIf="isQuestionsLoading" style="text-align:center; padding:30px; color:#94a3b8;">Loading...</div>
        <div *ngIf="!isQuestionsLoading && questions.length === 0"
          style="text-align:center; padding:30px; color:#94a3b8;">
          No questions yet. Add your first question below.
        </div>
        <div *ngFor="let q of questions; let i = index" style="padding:16px 20px; border-bottom:1px solid #f1f5f9;">
          <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <div>
              <strong style="color:#4f46e5;">Q{{ i + 1 }}.</strong>
              <span style="margin-left:8px;">{{ q.questionText }}</span>
              <span style="margin-left:12px; font-size:12px; background:#f1f5f9; padding:2px 8px; border-radius:4px;">{{
                q.questionType }} · {{ q.points }} pts</span>
            </div>
            <button class="btn-icon delete" (click)="deleteQuestion(q.id)" title="Delete"><i
                class="fa-solid fa-trash"></i></button>
          </div>
          <div *ngIf="q.options && q.options.length > 0" style="margin-top:8px; padding-left:28px;">
            <div *ngFor="let opt of q.options" style="display:flex; align-items:center; gap:8px; margin-top:4px;">
              <i class="fa-solid" [ngClass]="opt.isCorrect ? 'fa-circle-check' : 'fa-circle'"
                [style.color]="opt.isCorrect ? '#16a34a' : '#cbd5e1'"></i>
              <span [style.fontWeight]="opt.isCorrect ? '600' : '400'">{{ opt.optionText }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Add New Question Form -->
      <div class="panel">
        <div class="panel-header">
          <h3>Add New Question</h3>
        </div>
        <div style="padding: 20px;">
          <div class="row" style="margin-bottom:16px;">
            <div style="flex:3;">
              <label>Question Text</label>
              <textarea [(ngModel)]="newQuestion.questionText" placeholder="Enter your question..." rows="3"
                style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:8px; resize:vertical;"></textarea>
            </div>
            <div style="flex:1;">
              <label>Type</label>
              <select [(ngModel)]="newQuestion.questionType"
                style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:8px;">
                <option value="MCQ">MCQ</option>
                <option value="short_answer">Short Answer</option>
                <option value="essay">Essay</option>
              </select>
              <label style="margin-top:8px;">Points</label>
              <input type="number" [(ngModel)]="newQuestion.points" min="1"
                style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:8px;">
            </div>
          </div>

          <div *ngIf="newQuestion.questionType === 'MCQ'" style="margin-bottom:16px;">
            <label>Options (click radio to mark correct)</label>
            <div *ngFor="let opt of newQuestion.options; let i = index"
              style="display:flex; align-items:center; gap:10px; margin-top:8px;">
              <input type="radio" name="correctOption" [checked]="opt.isCorrect" (change)="setCorrectOption(i)">
              <input type="text" [(ngModel)]="opt.optionText" [placeholder]="'Option ' + (i + 1)"
                style="flex:1; padding:8px 12px; border:1px solid #e2e8f0; border-radius:8px;">
            </div>
          </div>

          <div *ngIf="newQuestion.questionType === 'short_answer'" style="margin-bottom:16px;">
            <label>Model Answer (Correct Answer)</label>
            <textarea [(ngModel)]="newQuestion.modelAnswer" placeholder="Enter the correct answer for auto-grading..."
              rows="2" style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:8px;"></textarea>
          </div>

          <button class="btn-primary" (click)="addQuestion()"><i class="fa-solid fa-plus"></i> Add Question</button>
        </div>
      </div>
    </div>

    <!-- ==================== VIEW 4: STUDENTS LIST (Your Data) ==================== -->
    <div *ngIf="currentView === 'students'" class="view-section fade-in">
      <div class="page-header">
        <div>
          <h1>Student Roster</h1>
          <p>Manage enrollments and view student status.</p>
        </div>
        <button class="btn-primary"><i class="fa-solid fa-user-plus"></i> Add Student</button>
      </div>

      <div class="panel">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Student Name</th>
              <th>Department</th>
              <th>Batch</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- We loop through filteredStudents (search result) -->
            <tr *ngFor="let s of filteredStudents">
              <td style="font-family: monospace; font-weight: 600;">#{{ s.id }}</td>
              <td>
                <div style="display:flex; align-items:center; gap:12px;">
                  <img [src]="s.photo" alt="Avatar" style="width:36px; height:36px; border-radius:50%;">
                  <div>
                    <div style="font-weight:600; color:var(--text-main);">{{ s.name }}</div>
                    <div style="font-size:12px; color:var(--text-muted);">{{ s.email }}</div>
                  </div>
                </div>
              </td>
              <td><span
                  style="background:#f1f5f9; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:600;">{{
                  s.dept }}</span></td>
              <td>{{ s.batch }}</td>
              <td>
                <!-- Dynamic Status Color -->
                <span [class]="getStatusClass(s.status)">
                  <i class="fa-solid"
                    [ngClass]="{'fa-circle-check': s.status === 'Active', 'fa-pen-to-square': s.status === 'Examining', 'fa-ban': s.status === 'Blocked'}"></i>
                  {{ s.status }}
                </span>
              </td>
              <td>
                <div style="display:flex; gap:8px;">
                  <button class="btn-icon" title="View"><i class="fa-solid fa-eye"></i></button>
                  <button class="btn-icon" title="Edit"><i class="fa-solid fa-pen"></i></button>
                </div>
              </td>
            </tr>
            <!-- Show if no results -->
            <tr *ngIf="filteredStudents.length === 0">
              <td colspan="6" style="text-align:center; padding:40px; color:#64748b;">
                <i class="fa-solid fa-magnifying-glass" style="margin-bottom:10px;"></i>
                <p>No students found.</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- ==================== MODAL (CREATE EXAM) ==================== -->
<div class="modal-overlay" *ngIf="isModalOpen">
  <div class="modal-card">
    <div class="modal-header">
      <h2>Create New Exam</h2>
      <button class="close-btn" (click)="closeModal()"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <label>Exam Title</label>
      <input type="text" [(ngModel)]="newExam.title" placeholder="e.g. Final Semester Physics">

      <div class="row">
        <div>
          <label>Subject</label>
          <select [(ngModel)]="newExam.subject">
            <option>Computer Science</option>
            <option>Mathematics</option>
            <option>Physics</option>
          </select>
        </div>
        <div>
          <label>Duration (Mins)</label>
          <input type="number" [(ngModel)]="newExam.duration">
        </div>
      </div>

      <!-- Scheduling -->
      <div class="row">
        <div>
          <label>Start Time (Required)</label>
          <input type="datetime-local" [(ngModel)]="newExam.startTime">
        </div>
        <div>
          <label>End Time (Optional)</label>
          <input type="datetime-local" [(ngModel)]="newExam.endTime">
        </div>
      </div>

      <!-- Group Assignment -->
      <div style="margin-top: 15px;">
        <label>Assign to Groups (Optional - leave empty for Global Exam)</label>
        <div class="group-list"
          style="max-height: 100px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
          <div *ngIf="groups.length === 0" style="color: #888; font-size: 0.9em;">No groups found. Create a group first.
          </div>
          <div *ngFor="let group of groups" style="margin-bottom: 5px;">
            <label style="display: flex; align-items: center; gap: 8px; font-weight: normal; font-size: 0.95em;">
              <input type="checkbox" [value]="group.id" (change)="toggleGroupSelection(group.id, $event)">
              {{ group.name }} ({{ group.memberCount || 0 }} members)
            </label>
          </div>
        </div>
      </div>

      <h4>Security Settings</h4>
      <div class="toggle-row">
        <span>Browser Lockdown</span>
        <input type="checkbox" [(ngModel)]="newExam.security.browserLock">
      </div>
      <div class="toggle-row">
        <span>AI Proctoring</span>
        <input type="checkbox" [(ngModel)]="newExam.security.aiProctor">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeModal()">Cancel</button>
      <button class="btn-primary" (click)="createExam()">Save & Publish</button>
    </div>
  </div>
</div>